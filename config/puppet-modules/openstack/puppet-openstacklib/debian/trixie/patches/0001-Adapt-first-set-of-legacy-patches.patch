From c5ae158b3cbb4134eeefdda17f74981239984d2f Mon Sep 17 00:00:00 2001
From: Dan Voiculeasa <dan.voiculeasa@windriver.com>
Date: Mon, 20 Sep 2021 12:05:10 +0300
Subject: [PATCH] Adapt first set of legacy patches

Adapt 0001-Roll-up-TIS-patches.patch from CentOS.

Signed-off-by: Dan Voiculeasa <dan.voiculeasa@windriver.com>
---
 lib/puppet/provider/openstack.rb             |  1 +
 lib/puppet/provider/openstack/auth.rb        | 16 ++++++++++++++--
 lib/puppet/provider/openstack/credentials.rb |  2 --
 3 files changed, 15 insertions(+), 4 deletions(-)

diff --git a/lib/puppet/provider/openstack.rb b/lib/puppet/provider/openstack.rb
index c943993..fe6e559 100644
--- a/lib/puppet/provider/openstack.rb
+++ b/lib/puppet/provider/openstack.rb
@@ -49,6 +49,7 @@ class Puppet::Provider::Openstack < Puppet::Provider
     begin
       action = args[1]
       Timeout.timeout(command_timeout(action)) do
+        args.unshift('--os-interface', 'internal')
         execute([command(:openstack_command)] + args, override_locale: false, failonfail: true, combine: true)
       end
     rescue Timeout::Error
diff --git a/lib/puppet/provider/openstack/auth.rb b/lib/puppet/provider/openstack/auth.rb
index 5a181da..be87492 100644
--- a/lib/puppet/provider/openstack/auth.rb
+++ b/lib/puppet/provider/openstack/auth.rb
@@ -1,9 +1,19 @@
 #require 'puppet/provider/openstack/credentials'
 require File.join(File.dirname(__FILE__), '..','..','..', 'puppet/provider/openstack/credentials')
+require 'hiera_puppet'
 
 module Puppet::Provider::Openstack::Auth
 
-  RCFILENAME = "#{ENV['HOME']}/openrc"
+  RCFILENAME = "/etc/platform/openrc"
+
+  def lookup_hiera(key)
+    HieraPuppet.lookup(key, :undef, self, nil, :priority)
+  end
+
+  def get_admin_password
+   value=lookup_hiera('keystone::admin_password')
+   return value
+  end
 
   CLOUDSFILENAMES = [
     # This allows overrides by users
@@ -36,7 +46,7 @@ module Puppet::Provider::Openstack::Auth
     unless rcfile.nil?
       File.open(rcfile).readlines.delete_if{|l| l=~ /^#|^$/ }.each do |line|
         # we only care about the OS_ vars from the file LP#1699950
-        if line =~ /OS_/
+        if line =~ /OS_/ and line.include?('=')
           key, value = line.split('=')
           key = key.split(' ').last
           value = value.chomp.gsub(/'/, '')
@@ -73,6 +83,8 @@ module Puppet::Provider::Openstack::Auth
         @credentials.unset
         set_credentials(@credentials, get_os_vars_from_rcfile(rc_filename))
       end
+      # retrieves the password from hiera data since keyring is not yet available
+      @credentials.password = get_admin_password
     end
 
     unless @credentials.set? and (!@credentials.scope_set? or @credentials.scope == scope)
diff --git a/lib/puppet/provider/openstack/credentials.rb b/lib/puppet/provider/openstack/credentials.rb
index 0260af6..cabb690 100644
--- a/lib/puppet/provider/openstack/credentials.rb
+++ b/lib/puppet/provider/openstack/credentials.rb
@@ -84,12 +84,10 @@ class Puppet::Provider::Openstack::CredentialsV3 < Puppet::Provider::Openstack::
     :domain_id,
     :domain_name,
     :key,
-    :project_domain_id,
     :project_domain_name,
     :project_id,
     :system_scope,
     :trust_id,
-    :user_domain_id,
     :user_domain_name,
     :user_id,
     :cloud,
-- 
2.34.1

